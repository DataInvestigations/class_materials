---
title: "Supporting Analyses/Statistics"
author: "Hannah Reeb"
date: "2024-10-22 version"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Repeatability
We first estimate repeatability using the Lessells-Boag equation for repeatability, then confirm accuracy of the estimate and establish confidence interval using the r package ICC. This package also uses variables as defined in Lessells and Boag (1987). Agreement between the two methods for estimating ICC is good. 

#### LBE Equation function
```{r}
r<-function(MSA, MSW, n){((MSA-MSW)/n)/(MSW+((MSA-MSW)/n))}
```


## Area Repeatability: Image results
Read in data sheet 
```{r}
library(tidyr)
patchrep <- read.csv("MasterPatchAreaRepeat.csv")

#this data sheet contains all the data used in the below individual data sheets (patchrep1-3), merged into one sheet for easy access. The individual data sheets were used so that no NAs were introduced. 
library(ICC)
```
#### Visual and statistical checks for normality:    
Normal/Gaussian distributions are required for use in LBE    

```{r}
qqnorm(patchrep$Original.Image)
qqline(patchrep$Original.Image)
shapiro.test(patchrep$Original.Image)
qqnorm(patchrep$Repeat.on.New.Image)
qqline(patchrep$Repeat.on.New.Image)
shapiro.test(patchrep$Repeat.on.New.Image)
qqnorm(patchrep$Repeat.on.Original.Image)
qqline(patchrep$Repeat.on.Original.Image)
shapiro.test(patchrep$Repeat.on.Original.Image)

```

#### For area, there are three versions of calculated repeatability: 

### Version 1: Original Measure + Original Image **VS** Repeat Measure + Repeat Image
**r or ICC =0.51
```{r}

differpics <- patchrep[c("ID","Original.Image","Repeat.on.New.Image")]
differpics <- as_tibble(differpics)
differpivot <- differpics %>% 
  pivot_longer(
    cols = c("Repeat.on.New.Image", "Original.Image"),
    names_to = "survey_num", 
    values_to = "Area",
    values_drop_na = TRUE
  )
differpivot$ID<-as.factor(differpivot$ID)
summary(aov(data = differpivot, Area ~ ID))
Albe <- r(172.17, 56.31, 2)
Albe
#Estimate 95% Confidence Interval
ICCest(x=ID, y=Area, data=differpivot)
```
### Version 2: Original Measure + Original Image **VS** Repeat Measure + Original Image
**r = 0.74**
This measure was selected as repeatability value for analysis
```{r}
patchrep2 <- read.csv("MasterPatchAreaRepeatSAMEPICS.csv")
samepics <- patchrep2[c("ID","Original.Image","Repeat.on.Original.Image")]
samepics <- as_tibble(samepics)
samepicpivot <- samepics %>% 
  pivot_longer(
    cols = c("Repeat.on.Original.Image", "Original.Image"),
    names_to = "survey_num", 
    values_to = "Area",
  )
samepicpivot$ID <- as.factor(samepicpivot$ID)
summary(aov(data = samepicpivot, Area ~ ID))
Blbe <- r(190.73, 27.91, 2)
Blbe
#Estimate 95% confidence interval
ICCest(x=ID, y=Area, data=samepicpivot)
```
### Version 3: Repeat Measure + Repeat Image **VS** Repeat Measure + Original Image
**r = 0.87** 
This measure likely emphasizes improvement on researcher's accuracy/skill in measuring
```{r}
patchrep3 <- read.csv("MasterPatchAreaRepeatREPvREP.csv")
repvrep <- patchrep3[c("ID","Repeat.on.New.Image","Repeat.on.Original.Image")]
repvrep <- as_tibble(repvrep)
reppivot <- repvrep %>% 
  pivot_longer(
    cols = c("Repeat.on.Original.Image", "Repeat.on.New.Image"),
    names_to = "survey_num", 
    values_to = "Area",
  )
reppivot$ID <- as.factor(reppivot$ID)
#this dataset is one pair short of 50
summary(aov(data = reppivot, Area ~ ID))
Clbe <- r(150.64, 10.42, 2)
Clbe
ICCest(x=ID, y=Area, data=reppivot)

```
## Brightness Repeatability: Spectroscopy results

### Decide measure of central tendency for brightness measures
5 measures of brightness per sample ID: decide mean vs. median to condense brightness data. Skewed data should use median. Normally distributed should use mean.     
    
```{r}
#read in brightness data that has not been aggregated
raw <- read.csv("noAggForeheadBrightness.csv")

# convert to 0-1, rather than 0-100 (this is how the data will be used in later regression modeling)
raw$forehead <- raw$forehead / 100
rawhist <- hist(x = raw$forehead)
qqnorm(raw$forehead, pch = 1, frame = FALSE)
qqline(raw$forehead, col = "steelblue", lwd = 2)
#visually skewed in histogram and qq-plot
#confirm non-normal dist. with shapiro-wilk and kolmogorov-smirnov
library("dgof")
# ks test reveals non normal distribution-- median measure of B2 ideal
ks.test(raw$forehead,"pnorm")
# shapiro test reveals non normal distribution-- median measure of B2 ideal
shapiro.test(raw$forehead)
```
### Calculate LBE repeatability brightness
#### For raw, unaggregated measures of brightness
**r=0.6828**
```{r}
brightrep <- read.csv("mergeRawBrightRepOrig.csv")
#rename and limit data sheet to forehead 
names(brightrep)[5] <- "repeat_forehead"
names(brightrep)[8] <- "original_forehead"
forehead<- brightrep[c("ID","repeat_forehead","original_forehead")]

#pivot chart to create usable data cols for repeatability
forehead$repeat_ID <- forehead$ID
names(forehead)[1] <- "1_ID"
names(forehead)[4] <- "2_ID"
library(tidyr)
#put the columns listing brightness into one col, still associated with ID
#then, make col for survey number (repeat or original)
forehead <- as_tibble(forehead)
forepivoted <- forehead %>% 
  pivot_longer(
    cols = c("repeat_forehead", "original_forehead"),
    names_to = "survey_num", 
    values_to = "B2noAgg",
  )
#remove duplicate ID column, rename just ID
forepivoted<- forepivoted[,-2]
names(forepivoted)[1] <- "ID"
forepivoted$ID <- as.factor(forepivoted$ID)
summary(aov(data = forepivoted, B2noAgg ~ ID))
Flbe <- r(6.42, 1.21, 10)
Flbe
ICCest(x=ID, y=B2noAgg, data=forepivoted)

```
## Potential outliers in patch area
In repeatability data set, birds with 'defects' were identified. Test to see if these specimen IDs are outliers. If they are-- remove them from dataset. If not outliers, leave in. 
```{r}
#identify statistical outliers
rep1 <- read.csv("OldPicAreaMerge.csv")

library(rstatix)
listoutRep <- identify_outliers(data=rep1, variable= "RepeatArea")
listoutOrig <- identify_outliers(data=rep1, variable= "OriginalArea")
```
    
Neither ID issued by outlier test was identified as having a defect in the patch; likely do not need to go back and take out defect patches. Also, I think it may introduce another way for researcher error/bias to creep in-- might have been hard to quantify 'defect' beyond what was chosen for the making of the dataset. If birds were severely dirty/defeathered/etc. they weren't chosen for measurement.

### Supplemental Analyses

Analysis of Mixed Model approach for supplement (ESM4)

## Brightness
```{r}
require(tidyverse)
require(glmmTMB)
bright <- read.csv("5NovPatchData.csv")

# Convert to proper data types
bright$Cat.Year <- factor(bright$Cat.Year)
bright$Sex <- factor(bright$Sex)

# Center Year to avoid collinearity between Year and YearÂ²
bright$Year.c <- scale(bright$Year, center = TRUE, scale = FALSE)
bright$Year.c2 <- bright$Year.c^2

# Fit model
mix.beta.glm <- glmmTMB(
  forehead ~ Sex + scale(Colony.Size) + Year.c + Year.c2 + (1 | Cat.Year),
  data = bright,
  family = beta_family(link = "logit"),
  control = glmmTMBControl(
    optimizer = optim,
    optArgs = list(method = "BFGS")
  )
)

summary(mix.beta.glm)

```
## Area
```{r}
finaldata <- read.csv("5NovPatchData.csv")

library(lme4)
library(lmerTest)
library(car)

#convert data type
finaldata$Cat.Year <- as.factor(finaldata$Cat.Year)
#set up mixed model
ar <- lmer(Area ~ log(Colony.Size) + Year + Sex + Date + year2 + (1|Cat.Year),
           data = finaldata)
mod5 <- Anova(ar, type = 3, test.statistic = 'F')
mod5

```

